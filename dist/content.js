(()=>{var P=class{calculateIndex(e){let r=this.countWords(e),t=this.countSentences(e),o=this.countCharacters(e);if(r===0||t===0)return 0;let s=o/r*100,a=t/r*100,n=.0588*s-.296*a-15.8;return Math.round(n*10)/10}getComplexityClassification(e){return e<=6?"Simple":e<=9?"Easy":e<=12?"Moderate":e<=15?"Complex":"Very Complex"}getReadabilityLevel(e){return e<=6?"Elementary":e<=9?"Middle School":e<=12?"High School":e<=15?"College":"Graduate"}countWords(e){return e.trim().split(/\s+/).filter(t=>t.length>0).length}countSentences(e){let r=e.split(/[.!?]+/).filter(t=>t.trim().length>10);return Math.max(1,r.length)}countCharacters(e){let r=e.match(/[a-zA-Z0-9]/g);return r?r.length:0}},E=class{constructor(){this.contentSelectors=[{selector:"main",priority:10},{selector:"article",priority:9},{selector:'[role="main"]',priority:8},{selector:".content",priority:7},{selector:".post-content",priority:7},{selector:".entry-content",priority:7},{selector:".article-content",priority:7},{selector:".text-content",priority:6},{selector:".main-content",priority:6},{selector:"#content",priority:5},{selector:".container",priority:3},{selector:"body",priority:1}]}extractMainContent(){let e=this.findBestContentContainer();if(!e)return{text:"",title:document.title||"Untitled",element:null};let r=this.extractAndCleanText(e),t=this.extractTitle();return{text:r,title:t,element:e}}findBestContentContainer(){for(let{selector:e}of this.contentSelectors){let r=document.querySelectorAll(e);for(let t of r)if(this.isGoodContentContainer(t))return console.log(`\u{1F4DD} Using content container: ${e}`),t}return console.warn("\u26A0\uFE0F No suitable content container found, using body"),document.body}isGoodContentContainer(e){return(e.textContent||"").trim().split(/\s+/).length>=50&&!this.isNavigationElement(e)&&!this.isFooterElement(e)&&this.hasGoodTextDensity(e)}isNavigationElement(e){let r=e.tagName.toLowerCase(),t=e.className.toLowerCase(),o=e.getAttribute("role")||"";return r==="nav"||o==="navigation"||t.includes("nav")||t.includes("menu")||t.includes("sidebar")}isFooterElement(e){let r=e.tagName.toLowerCase(),t=e.className.toLowerCase();return r==="footer"||t.includes("footer")}hasGoodTextDensity(e){let r=e.querySelectorAll("*").length,t=(e.textContent||"").length;return r===0||t/r>10}extractAndCleanText(e){let r=e.textContent||"";return r=r.replace(/\s+/g," ").replace(/\n+/g," ").replace(/\t+/g," ").trim(),r}extractTitle(){let e=[()=>document.querySelector("h1")?.textContent,()=>document.querySelector('[role="heading"][aria-level="1"]')?.textContent,()=>document.querySelector(".article-title")?.textContent,()=>document.querySelector(".post-title")?.textContent,()=>document.querySelector(".entry-title")?.textContent,()=>document.title];for(let r of e){let t=r()?.trim();if(t&&t.length>0)return t}return"Untitled"}},W=class{constructor(){this.unsuitableHostnames=["youtube.com","www.youtube.com","m.youtube.com","youtu.be","vimeo.com","dailymotion.com","twitch.tv","www.twitch.tv","netflix.com","hulu.com","disney.com","spotify.com","soundcloud.com","bandcamp.com","facebook.com","www.facebook.com","m.facebook.com","twitter.com","x.com","linkedin.com","instagram.com","tiktok.com","snapchat.com","reddit.com","www.reddit.com","discord.com","slack.com","teams.microsoft.com","whatsapp.com","telegram.org","signal.org"];this.unsuitablePatterns=["/admin","/dashboard","/wp-admin","/wp-login","/login","/signin","/signup","/register","/checkout","/cart","/payment","/billing"]}isPageSuitable(){let e=window.location.href.toLowerCase(),r=window.location.hostname.toLowerCase(),t=window.location.pathname.toLowerCase();if(e.startsWith("chrome-extension://")||e.startsWith("moz-extension://")||e.startsWith("ms-browser-extension://"))return console.log("\u{1F6AB} Skipping analysis - extension page detected"),!1;for(let o of this.unsuitableHostnames)if(r.includes(o))return console.log(`\u{1F6AB} Skipping analysis - unsuitable site: ${o}`),!1;for(let o of this.unsuitablePatterns)if(t.includes(o))return console.log(`\u{1F6AB} Skipping analysis - unsuitable page: ${o}`),!1;return this.hasMinimumContent()?!0:(console.log("\u{1F6AB} Skipping analysis - insufficient content"),!1)}hasMinimumContent(){let r=(document.body.textContent||"").trim().split(/\s+/).length,t=document.querySelectorAll("p").length;return r>=100&&t>=2}},x=class{constructor(){this.colemanLiau=new P;this.extractor=new E;this.suitabilityDetector=new W;this.baseReadingSpeedWPM=225}async analyzeCurrentPage(e=this.baseReadingSpeedWPM){if(console.log("\u{1F4CA} Starting text analysis..."),!this.suitabilityDetector.isPageSuitable())return console.log("\u{1F6AB} Page not suitable for analysis"),null;let{text:r,title:t,element:o}=this.extractor.extractMainContent();if(!r||r.length<100)return console.log("\u{1F6AB} Insufficient text content for analysis"),null;let s=this.colemanLiau.calculateIndex(r),a=this.colemanLiau.getComplexityClassification(s),n=this.colemanLiau.getReadabilityLevel(s),l=r.trim().split(/\s+/).length,c=r.split(/[.!?]+/).filter(B=>B.trim().length>0).length,d=(r.match(/[a-zA-Z0-9]/g)||[]).length,p=Math.round(l/Math.max(1,c)*10)/10,g=Math.round(d/l*10)/10,b=e;s>15?b*=.8:s>12?b*=.9:s<6&&(b*=1.1);let T=Math.ceil(l/b),S={wordCount:l,readingTime:T,complexity:{averageSentenceLength:p,averageCharactersPerWord:g,complexityScore:a,readabilityLevel:n,colemanLiauIndex:s},url:window.location.href,title:t,timestamp:Date.now(),textContent:r};return console.log("\u2705 Analysis complete:",S),S}getMainContentElement(){let{element:e}=this.extractor.extractMainContent();return e}setReadingSpeed(e){this.baseReadingSpeedWPM=e,console.log(`\u{1F4D6} Reading speed updated to ${e} WPM`)}};var w=class{constructor(e={},r={}){this.isActive=!1;this.isPaused=!1;this.currentWordIndex=0;this.words=[];this.originalContent="";this.contentContainer=null;this.revealTimer=null;this.startTime=0;this.keyboardListener=null;this.config={wpm:225,highlightColor:"#4285f4",progressIndicator:!0,keyboardControls:!0,autoScroll:!0,...e},this.events=r}async startBlurMode(e){try{if(console.log("\u{1F3AF} Starting BlurMode..."),this.contentContainer=e||this.findMainContent(),!this.contentContainer)return console.error("\u274C No suitable content found for blur mode"),!1;this.originalContent=this.contentContainer.innerHTML;let r=this.processTextContent();return r===0?(console.error("\u274C No words found to process"),!1):(this.isActive=!0,this.isPaused=!1,this.currentWordIndex=0,this.startTime=Date.now(),this.config.keyboardControls&&this.setupKeyboardControls(),this.hideAllWords(),this.startRevealTimer(),console.log(`\u2705 BlurMode started: ${r} words at ${this.config.wpm} WPM`),this.events.onStart?.(),!0)}catch(r){return console.error("\u274C Failed to start blur mode:",r),!1}}stopBlurMode(){if(!this.isActive)return;console.log("\u23F9\uFE0F Stopping BlurMode..."),this.revealTimer&&(clearInterval(this.revealTimer),this.revealTimer=null),this.keyboardListener&&(document.removeEventListener("keydown",this.keyboardListener),this.keyboardListener=null),this.contentContainer&&this.originalContent&&(this.contentContainer.innerHTML=this.originalContent);let e=this.getStats();this.isActive=!1,this.isPaused=!1,this.currentWordIndex=0,this.words=[],console.log("\u2705 BlurMode stopped, content restored"),this.events.onStop?.(),this.events.onComplete?.(e)}togglePause(){this.isActive&&(this.isPaused?this.resumeBlurMode():this.pauseBlurMode())}pauseBlurMode(){this.revealTimer&&(clearInterval(this.revealTimer),this.revealTimer=null),this.isPaused=!0,console.log("\u23F8\uFE0F BlurMode paused"),this.events.onPause?.()}resumeBlurMode(){this.startRevealTimer(),this.isPaused=!1,console.log("\u25B6\uFE0F BlurMode resumed"),this.events.onResume?.()}adjustSpeed(e){this.config.wpm=Math.max(50,Math.min(800,e)),this.isActive&&!this.isPaused&&(this.revealTimer&&clearInterval(this.revealTimer),this.startRevealTimer()),console.log(`\u{1F39B}\uFE0F BlurMode speed adjusted to ${this.config.wpm} WPM`)}getStats(){let e=this.isActive?Date.now()-this.startTime:0,r=e>0?this.currentWordIndex/(e/6e4):0;return{wordsRevealed:this.currentWordIndex,totalWords:this.words.length,timeElapsed:e,currentWPM:Math.round(r),isActive:this.isActive,isPaused:this.isPaused}}findMainContent(){let e=["main","article",'[role="main"]',".main-content",".article-content",".post-content",".content","#content",'div[id*="content"]','div[class*="content"]'];for(let s of e){let a=document.querySelector(s);if(a&&a.textContent&&a.textContent.trim().length>100)return a}let r=document.querySelectorAll("div, section, article"),t=null,o=0;for(let s of r){let a=s.textContent?.trim()||"";a.length>o&&a.length>500&&(t=s,o=a.length)}return t}processTextContent(){if(!this.contentContainer)return 0;let e=document.createTreeWalker(this.contentContainer,NodeFilter.SHOW_TEXT,{acceptNode:s=>{let a=s.parentNode;if(!a)return NodeFilter.FILTER_REJECT;let n=a.tagName.toLowerCase();if(["script","style","noscript","code","pre"].includes(n))return NodeFilter.FILTER_REJECT;let l=s.textContent?.trim();return l&&l.length>0?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}}),r=[],t;for(;t=e.nextNode();)r.push(t);let o=0;for(let s of r){let n=(s.textContent||"").split(/(\s+)/).filter(d=>d.trim().length>0);if(n.length===0)continue;let l=s.parentNode;if(!l)continue;let c=document.createDocumentFragment();for(let d=0;d<n.length;d++){let p=n[d];if(p.trim().length===0)continue;let g=document.createElement("span");g.textContent=p,g.className="blur-word",g.dataset.wordIndex=o.toString(),g.style.cssText=`
          visibility: hidden;
          transition: all 0.2s ease;
        `,c.appendChild(g),this.words.push(g),o++,d<n.length-1&&c.appendChild(document.createTextNode(" "))}l.replaceChild(c,s)}return this.words.length}hideAllWords(){this.words.forEach(e=>{e.style.visibility="hidden",e.style.backgroundColor="transparent"})}startRevealTimer(){let e=6e4/this.config.wpm;this.revealTimer=window.setInterval(()=>{this.revealNextWord()},e)}revealNextWord(){if(this.currentWordIndex>=this.words.length){this.stopBlurMode();return}if(this.currentWordIndex>0){let r=this.words[this.currentWordIndex-1];r.style.backgroundColor="transparent"}let e=this.words[this.currentWordIndex];e.style.visibility="visible",e.style.backgroundColor=this.config.highlightColor+"33",this.config.autoScroll&&e.scrollIntoView({behavior:"smooth",block:"center"}),this.events.onWordRevealed?.(this.currentWordIndex,e.textContent||""),this.currentWordIndex++}setupKeyboardControls(){this.keyboardListener=e=>{if(this.isActive)switch(e.code){case"Space":e.preventDefault(),this.togglePause();break;case"Escape":e.preventDefault(),this.stopBlurMode();break;case"ArrowRight":e.preventDefault(),this.isPaused&&this.currentWordIndex<this.words.length&&this.revealNextWord();break;case"ArrowLeft":e.preventDefault(),this.isPaused&&this.currentWordIndex>0&&(this.currentWordIndex=Math.max(0,this.currentWordIndex-2),this.hideWordsAfter(this.currentWordIndex),this.revealNextWord());break;case"KeyR":e.preventDefault(),this.restartBlurMode();break}},document.addEventListener("keydown",this.keyboardListener)}hideWordsAfter(e){for(let r=e;r<this.words.length;r++)this.words[r].style.visibility="hidden",this.words[r].style.backgroundColor="transparent"}restartBlurMode(){this.isActive&&(this.currentWordIndex=0,this.startTime=Date.now(),this.hideAllWords(),this.revealTimer&&clearInterval(this.revealTimer),this.isPaused||this.startRevealTimer(),console.log("\u{1F504} BlurMode restarted"))}isBlurModeActive(){return this.isActive}getConfig(){return{...this.config}}updateConfig(e){this.config={...this.config,...e}}};var M=class{constructor(e={},r={},t){this.currentSession=null;this.goals={dailyWordGoal:2e3,weeklyGoalEnabled:!0,weeklyWordGoal:14e3,streakGoalEnabled:!0,targetStreakDays:7,...e},this.events=r,this.storageManager=t}async startSession(e,r,t=225){this.currentSession?.isActive&&await this.endSession();let o=this.generateSessionId();return this.currentSession={id:o,startTime:Date.now(),url:e,title:r,wordsRead:0,pagesAnalyzed:0,blurModeUsed:!1,completionRate:0,targetWPM:t,duration:0,isActive:!0},console.log("\u{1F680} Reading session started:",o),this.events.onSessionStart?.(this.currentSession),this.currentSession}async endSession(){if(!this.currentSession||!this.currentSession.isActive)return null;let e=Date.now();this.currentSession.endTime=e,this.currentSession.duration=e-this.currentSession.startTime,this.currentSession.isActive=!1,this.currentSession.blurModeWords&&this.currentSession.duration>0&&(this.currentSession.actualWPM=Math.round(this.currentSession.blurModeWords/(this.currentSession.duration/6e4))),await this.saveSession(this.currentSession);let r=await this.calculateStatistics();await this.updateDailyProgress(),await this.updateStreak(),console.log("\u23F9\uFE0F Reading session ended:",this.currentSession.id),this.events.onSessionEnd?.(this.currentSession,r);let t={...this.currentSession};return this.currentSession=null,t}updateSessionProgress(e){this.currentSession?.isActive&&(Object.assign(this.currentSession,e),this.currentSession.duration=Date.now()-this.currentSession.startTime,this.storageManager&&this.saveSession(this.currentSession))}getCurrentSession(){return this.currentSession}async calculateStatistics(){let e=await this.getAllSessions(),r=this.getTodayString(),t=this.getThisWeekDates(),o=e.length,s=e.reduce((u,h)=>u+h.wordsRead,0),a=e.reduce((u,h)=>u+h.duration,0),n=e.filter(u=>u.endTime),l=n.length>0?n.reduce((u,h)=>u+(h.actualWPM||h.targetWPM),0)/n.length:0,c=n.length>0?a/n.length:0,d=e.filter(u=>u.blurModeUsed).length,p=o>0?d/o*100:0,g={};e.forEach(u=>{u.avgComplexity&&(g[u.avgComplexity]=(g[u.avgComplexity]||0)+1)});let b=Object.keys(g).reduce((u,h)=>g[u]>g[h]?u:h,"Moderate"),{currentStreak:T,longestStreak:S}=await this.calculateStreaks(),I=e.filter(u=>this.getDateString(u.startTime)===r).reduce((u,h)=>u+h.wordsRead,0),$=Math.min(1,I/this.goals.dailyWordGoal),L=this.calculateWeeklyStats(e,t),F=this.calculateMonthlyStats(e);return{totalSessions:o,totalWordsRead:s,totalTimeSpent:a,averageWPM:Math.round(l),averageSessionLength:Math.round(c),blurModeUsage:Math.round(p),favoriteComplexity:b,currentStreak:T,longestStreak:S,dailyGoalProgress:$,weeklyStats:L,monthlyStats:F}}async getTodayProgress(){let e=await this.getAllSessions(),r=this.getTodayString(),t=e.filter(n=>this.getDateString(n.startTime)===r),o=t.reduce((n,l)=>n+l.wordsRead,0),s=t.reduce((n,l)=>n+l.duration,0),a=o>=this.goals.dailyWordGoal;return{date:r,wordsRead:o,sessionsCount:t.length,timeSpent:s,goalMet:a}}updateGoals(e){this.goals={...this.goals,...e},this.storageManager&&this.storageManager.save("reading_goals",this.goals)}getGoals(){return{...this.goals}}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async saveSession(e){if(!this.storageManager)return;let r=await this.getAllSessions(),t=r.findIndex(o=>o.id===e.id);t>=0?r[t]=e:r.push(e),await this.storageManager.save("reading_sessions",r)}async getAllSessions(){if(!this.storageManager)return[];try{return await this.storageManager.get("reading_sessions")||[]}catch(e){return console.error("Failed to load sessions:",e),[]}}async calculateStreaks(){let e=await this.getAllSessions(),r=[...new Set(e.filter(l=>l.endTime).map(l=>this.getDateString(l.startTime)))].sort(),t=0,o=0,s=0,a=this.getTodayString(),n=this.getDateString(Date.now()-1440*60*1e3);for(let l=0;l<30;l++){let c=this.getDateString(Date.now()-l*24*60*60*1e3);if(r.includes(c)){if(l===0||l===1&&c===n)t++;else if(t===0)break}else{if(l===0&&r.includes(n))continue;if(t>0)break}}s=1;for(let l=1;l<r.length;l++){let c=new Date(r[l-1]);(new Date(r[l]).getTime()-c.getTime())/(1440*60*1e3)===1?s++:(o=Math.max(o,s),s=1)}return o=Math.max(o,s),{currentStreak:t,longestStreak:o}}async updateDailyProgress(){let e=await this.getTodayProgress();e.goalMet&&this.events.onGoalAchieved?.("daily"),this.events.onGoalProgress?.(e.wordsRead/this.goals.dailyWordGoal,"daily")}async updateStreak(){let{currentStreak:e,longestStreak:r}=await this.calculateStreaks(),t=e>r;this.events.onStreakUpdated?.(e,t),this.goals.streakGoalEnabled&&e>=this.goals.targetStreakDays&&this.events.onGoalAchieved?.("streak")}calculateWeeklyStats(e,r){return r.map(t=>{let o=e.filter(n=>this.getDateString(n.startTime)===t),s=o.reduce((n,l)=>n+l.wordsRead,0),a=o.reduce((n,l)=>n+l.duration,0);return{date:t,wordsRead:s,sessionsCount:o.length,timeSpent:a,goalMet:s>=this.goals.dailyWordGoal}})}calculateMonthlyStats(e){let r=this.getMonthString(),t=e.filter(c=>this.getMonthString(c.startTime)===r),o=t.reduce((c,d)=>c+d.wordsRead,0),s=t.reduce((c,d)=>c+d.duration,0),a=t.filter(c=>c.endTime),n=a.length>0?a.reduce((c,d)=>c+(d.actualWPM||d.targetWPM),0)/a.length:0,l=[...new Set(t.map(c=>this.getDateString(c.startTime)))];return{month:r,totalWords:o,totalSessions:t.length,totalTime:s,averageWPM:Math.round(n),streakDays:l.length}}getTodayString(){return this.getDateString(Date.now())}getDateString(e){return new Date(e).toISOString().split("T")[0]}getMonthString(e=Date.now()){return new Date(e).toISOString().substring(0,7)}getThisWeekDates(){let e=[],r=new Date,t=new Date(r);t.setDate(r.getDate()-r.getDay());for(let o=0;o<7;o++){let s=new Date(t);s.setDate(t.getDate()+o),e.push(this.getDateString(s.getTime()))}return e}async exportData(){let e=await this.getAllSessions(),r=await this.calculateStatistics();return{sessions:e,goals:this.goals,stats:r}}async importData(e){this.storageManager&&(e.sessions&&await this.storageManager.save("reading_sessions",e.sessions),e.goals&&(this.goals={...this.goals,...e.goals},await this.storageManager.save("reading_goals",this.goals)))}};var C=class{constructor(e={}){this.schemas=new Map;this.config={maxRetries:3,retryDelayMs:100,useExponentialBackoff:!0,enableFallback:!0,fallbackPrefix:"readwise_",validateData:!0,debugMode:!1,...e},this.config.debugMode&&console.log("\u{1F5C4}\uFE0F StorageManager initialized with config:",this.config)}async save(e,r,t=!1){if(!e||typeof e!="string")return{success:!1,error:"Invalid key: must be non-empty string"};if(this.config.validateData&&this.schemas.has(e)){let s=this.validateData(e,r);if(!s.isValid)return{success:!1,error:`Data validation failed: ${s.error}`}}this.config.debugMode&&console.log(`\u{1F4BE} Saving data to storage: ${e}`,r);let o=await this.attemptChromeStorage("save",e,r,t);if(o.success)return o;if(this.config.enableFallback){this.config.debugMode&&console.log(`\u{1F504} Chrome storage failed, trying localStorage fallback for: ${e}`);try{let s=this.config.fallbackPrefix+e,a=JSON.stringify(r);return localStorage.setItem(s,a),this.config.debugMode&&console.log(`\u2705 Successfully saved to localStorage: ${s}`),{success:!0,data:r,fromFallback:!0}}catch(s){return console.error("\u274C Both Chrome storage and localStorage failed:",s),{success:!1,error:`All storage methods failed. Chrome: ${o.error}, LocalStorage: ${s}`,fromFallback:!0}}}return o}async get(e,r,t=!1){if(!e||typeof e!="string")return{success:!1,error:"Invalid key: must be non-empty string"};this.config.debugMode&&console.log(`\u{1F4D6} Retrieving data from storage: ${e}`);let o=await this.attemptChromeStorage("get",e,void 0,t);if(o.success&&o.data!==void 0)if(this.config.validateData&&this.schemas.has(e)){let s=this.validateData(e,o.data);if(!s.isValid)console.warn(`\u26A0\uFE0F Retrieved data failed validation for key ${e}:`,s.error);else return o}else return o;if(this.config.enableFallback){this.config.debugMode&&console.log(`\u{1F504} Chrome storage failed/empty, trying localStorage fallback for: ${e}`);try{let s=this.config.fallbackPrefix+e,a=localStorage.getItem(s);if(a!==null){let n=JSON.parse(a);if(this.config.validateData&&this.schemas.has(e)){let l=this.validateData(e,n);if(!l.isValid)return console.warn(`\u26A0\uFE0F Fallback data failed validation for key ${e}:`,l.error),{success:!0,data:r,fromFallback:!0}}return this.config.debugMode&&console.log(`\u2705 Successfully retrieved from localStorage: ${s}`,n),{success:!0,data:n,fromFallback:!0}}}catch(s){console.error("\u274C localStorage fallback failed:",s)}}return r!==void 0?{success:!0,data:r,fromFallback:this.config.enableFallback}:{success:!1,error:`No data found for key: ${e}`,fromFallback:this.config.enableFallback}}async remove(e,r=!1){if(!e||typeof e!="string")return{success:!1,error:"Invalid key: must be non-empty string"};this.config.debugMode&&console.log(`\u{1F5D1}\uFE0F Removing data from storage: ${e}`);let t=!1,o=!1,s=[],a=await this.attemptChromeStorage("remove",e,void 0,r);if(a.success?t=!0:s.push(`Chrome storage: ${a.error}`),this.config.enableFallback)try{let n=this.config.fallbackPrefix+e;localStorage.removeItem(n),o=!0,this.config.debugMode&&console.log(`\u2705 Successfully removed from localStorage: ${n}`)}catch(n){s.push(`LocalStorage: ${n}`)}return t||o?{success:!0}:{success:!1,error:`Failed to remove from all storage methods: ${s.join(", ")}`}}async clear(e=!1){this.config.debugMode&&console.log("\u{1F9F9} Clearing all storage data");let r=!1,t=!1,o=[];try{this.isExtensionContextValid()&&(await(e?chrome.storage.local:chrome.storage.sync).clear(),r=!0,this.config.debugMode&&console.log("\u2705 Chrome storage cleared successfully"))}catch(s){o.push(`Chrome storage: ${s}`)}if(this.config.enableFallback)try{let s=[];for(let a=0;a<localStorage.length;a++){let n=localStorage.key(a);n&&n.startsWith(this.config.fallbackPrefix)&&s.push(n)}s.forEach(a=>localStorage.removeItem(a)),t=!0,this.config.debugMode&&console.log(`\u2705 Cleared ${s.length} localStorage fallback items`)}catch(s){o.push(`LocalStorage: ${s}`)}return r||t?{success:!0}:{success:!1,error:`Failed to clear storage: ${o.join(", ")}`}}async saveBatch(e,r=!1){if(!e||typeof e!="object")return{success:!1,error:"Invalid data: must be object with key-value pairs"};let t=Object.keys(e);if(t.length===0)return{success:!0};if(this.config.debugMode&&console.log(`\u{1F4E6} Batch saving ${t.length} items:`,t),this.config.validateData){let s=[];for(let a of t)if(this.schemas.has(a)){let n=this.validateData(a,e[a]);n.isValid||s.push(`${a}: ${n.error}`)}if(s.length>0)return{success:!1,error:`Batch validation failed: ${s.join(", ")}`}}let o=await this.attemptChromeStorage("saveBatch","",e,r);if(o.success)return o;if(this.config.enableFallback){this.config.debugMode&&console.log("\u{1F504} Batch Chrome storage failed, using localStorage fallback");let s=[],a=0;for(let[n,l]of Object.entries(e))try{let c=this.config.fallbackPrefix+n,d=JSON.stringify(l);localStorage.setItem(c,d),a++}catch(c){s.push(`${n}: ${c}`)}return a===t.length?(this.config.debugMode&&console.log(`\u2705 Batch localStorage fallback successful: ${a}/${t.length} items`),{success:!0,fromFallback:!0}):{success:!1,error:`Batch fallback partial failure: ${a}/${t.length} succeeded. Errors: ${s.join(", ")}`,fromFallback:!0}}return o}registerSchema(e,r){if(!e||typeof e!="string")throw new Error("Invalid key: must be non-empty string");if(!r||typeof r!="object")throw new Error("Invalid schema: must be object");this.schemas.set(e,r),this.config.debugMode&&console.log(`\u{1F4CB} Registered validation schema for key: ${e}`,r)}isExtensionContextValid(){try{return!(typeof chrome>"u"||!chrome.storage||!chrome.storage.sync||!chrome.storage.local||!chrome.runtime||!chrome.runtime.id)}catch{return!1}}async attemptChromeStorage(e,r,t,o=!1){let s="";for(let a=0;a<=this.config.maxRetries;a++)try{if(!this.isExtensionContextValid()){s="Extension context is invalid - chrome.storage unavailable",this.config.debugMode&&console.warn(`\u26A0\uFE0F Attempt ${a+1}: ${s}`);break}let n=o?chrome.storage.local:chrome.storage.sync,l;switch(e){case"save":return l=await n.set({[r]:t}),this.config.debugMode&&console.log(`\u2705 Chrome storage save successful: ${r}`),{success:!0,data:t,retryCount:a};case"get":l=await n.get([r]);let c=l[r];return this.config.debugMode&&console.log(`\u2705 Chrome storage get successful: ${r}`,c),{success:!0,data:c,retryCount:a};case"remove":return l=await n.remove([r]),this.config.debugMode&&console.log(`\u2705 Chrome storage remove successful: ${r}`),{success:!0,retryCount:a};case"saveBatch":return l=await n.set(t),this.config.debugMode&&console.log("\u2705 Chrome storage batch save successful"),{success:!0,retryCount:a};default:return{success:!1,error:`Unknown operation: ${e}`}}}catch(n){if(s=n instanceof Error?n.message:String(n),this.config.debugMode&&console.warn(`\u26A0\uFE0F Attempt ${a+1} failed for ${e}:${r}:`,s),a<this.config.maxRetries){let l=this.config.useExponentialBackoff?this.config.retryDelayMs*Math.pow(2,a):this.config.retryDelayMs;await this.delay(l)}}return{success:!1,error:s,retryCount:this.config.maxRetries}}validateData(e,r){let t=this.schemas.get(e);if(!t)return{isValid:!0};if(typeof r!="object"||r===null)return{isValid:!1,error:"Data must be object for schema validation"};for(let[o,s]of Object.entries(t)){let a=r[o];if(s.required&&a==null)return{isValid:!1,error:`Required property missing: ${o}`};if(a==null)continue;let n=Array.isArray(a)?"array":typeof a;if(n!==s.type)return{isValid:!1,error:`Property ${o} must be ${s.type}, got ${n}`};if(s.validate&&!s.validate(a))return{isValid:!1,error:`Property ${o} failed custom validation`}}return{isValid:!0}}delay(e){return new Promise(r=>setTimeout(r,e))}getConfig(){return{...this.config}}updateConfig(e){this.config={...this.config,...e},this.config.debugMode&&console.log("\u{1F527} StorageManager configuration updated:",this.config)}async getStorageStats(e=!1){try{if(!this.isExtensionContextValid())return{success:!1,error:"Extension context invalid - cannot check storage stats"};let r=e?chrome.storage.local:chrome.storage.sync,t=await r.getBytesInUse(),o=r.QUOTA_BYTES,s=Math.round(t/o*100);return{success:!0,data:{bytesInUse:t,quotaBytes:o,percentUsed:s}}}catch(r){return{success:!1,error:`Failed to get storage stats: ${r}`}}}};console.log("\u{1F680} ReadWise Pro - Content script loaded at:",new Date().toISOString());console.log("\u{1F310} Document ready state:",document.readyState);console.log("\u{1F517} Current URL:",window.location.href);var R,m,f,v,D=null,y=null;console.log("\u{1F527} Initializing ReadWise modules...");v=new C({debugMode:!0,enableFallback:!0,maxRetries:3});v.registerSchema("user_preferences",{wpm:{type:"number",required:!0,validate:i=>i>=50&&i<=800},theme:{type:"string",required:!1},dailyGoal:{type:"number",required:!1,validate:i=>i>0}});R=new x;f=new M({dailyWordGoal:2e3},{onSessionStart:i=>{console.log("\u{1F4CA} Reading session started:",i.id),y=i},onSessionEnd:(i,e)=>{console.log("\u{1F4CA} Reading session ended:",i.id,e),y=null},onGoalAchieved:i=>{console.log("\u{1F389} Goal achieved:",i)}},v);m=new w({wpm:225,highlightColor:"#4285f4",progressIndicator:!0,keyboardControls:!0,autoScroll:!0},{onStart:()=>{console.log("\u{1F3AF} Blur mode started"),y&&f.updateSessionProgress({blurModeUsed:!0})},onWordRevealed:(i,e)=>{y&&f.updateSessionProgress({blurModeWords:i+1,completionRate:(i+1)/(m.getStats().totalWords||1)})},onComplete:i=>{console.log("\u2705 Blur mode completed:",i),y&&f.updateSessionProgress({blurModeWords:i.wordsRevealed,completionRate:1})},onStop:()=>{console.log("\u23F9\uFE0F Blur mode stopped")}});console.log("\u2705 All ReadWise modules initialized successfully");var A=class{constructor(){this.overlays=new Map;this.nextZIndex=1e4}createOverlay(e){console.log("\u{1F4E6} Creating simple DOM overlay:",e.id),this.removeOverlay(e.id);let r=document.createElement("div");return r.id=`webray-overlay-${e.id}`,r.style.cssText=`
      position: fixed;
      left: ${e.position?.x||20}px;
      top: ${e.position?.y||20}px;
      z-index: ${this.nextZIndex++};
      background: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      max-width: 320px;
      cursor: ${e.draggable?"move":"default"};
    `,e.type==="debug"?r.innerHTML=`
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <div style="width: 12px; height: 12px; background: #4caf50; border-radius: 50%;"></div>
          <strong>WebRay-M Debug (Sidebar)</strong>
        </div>
        <div style="font-size: 12px; color: #666;">
          Framework: WebRay-M v2.0<br>
          Engine: Simple DOM<br>
          Type: Sidebar Extension<br>
          Page: ${document.title}
        </div>
        <button onclick="this.parentElement.remove()" style="
          margin-top: 8px; padding: 4px 8px; border: 1px solid #ddd; 
          background: #f5f5f5; border-radius: 4px; cursor: pointer;
        ">Close</button>
      `:e.type==="text"?r.innerHTML=`
        <div>${e.content||"Text overlay"}</div>
        <button onclick="this.parentElement.remove()" style="
          margin-top: 8px; padding: 4px 8px; border: 1px solid #ddd; 
          background: #f5f5f5; border-radius: 4px; cursor: pointer;
        ">Close</button>
      `:e.type==="sidebar"&&(r.innerHTML=`
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <div style="width: 12px; height: 12px; background: #ff9800; border-radius: 50%;"></div>
          <strong>WebRay-M Sidebar Panel</strong>
        </div>
        <div style="font-size: 12px; color: #666; margin-bottom: 12px;">
          This is a sidebar-style overlay that can contain<br>
          various tools and information panels.
        </div>
        <div style="display: flex; gap: 8px;">
          <button onclick="console.log('Sidebar action 1')" style="
            padding: 6px 12px; border: 1px solid #ddd; 
            background: #2196f3; color: white; border-radius: 4px; cursor: pointer;
          ">Action 1</button>
          <button onclick="console.log('Sidebar action 2')" style="
            padding: 6px 12px; border: 1px solid #ddd; 
            background: #4caf50; color: white; border-radius: 4px; cursor: pointer;
          ">Action 2</button>
        </div>
        <button onclick="this.parentElement.remove()" style="
          margin-top: 8px; padding: 4px 8px; border: 1px solid #ddd; 
          background: #f5f5f5; border-radius: 4px; cursor: pointer; width: 100%;
        ">Close Sidebar</button>
      `),e.draggable&&this.makeDraggable(r),document.body.appendChild(r),this.overlays.set(e.id,r),console.log("\u2705 Simple overlay created successfully"),r}makeDraggable(e){let r=!1,t=0,o=0,s=0,a=0;e.addEventListener("mousedown",n=>{r=!0,t=n.clientX,o=n.clientY;let l=e.getBoundingClientRect();s=l.left,a=l.top,e.style.opacity="0.8"}),document.addEventListener("mousemove",n=>{if(!r)return;let l=n.clientX-t,c=n.clientY-o;e.style.left=s+l+"px",e.style.top=a+c+"px"}),document.addEventListener("mouseup",()=>{r&&(r=!1,e.style.opacity="1")})}removeOverlay(e){let r=this.overlays.get(e);return r&&r.parentNode?(r.parentNode.removeChild(r),this.overlays.delete(e),!0):!1}},k=null;async function _(){return console.log("\u{1F4E6} Using simple DOM overlay system"),k=new A,!0}(async()=>{try{await _(),window.hasWebRayContentListener||(console.log("\u{1F3AF} Setting up message listener..."),chrome.runtime.onMessage.addListener((i,e,r)=>{if(console.log("\u{1F4E5} Content script received message:",i),i.action==="ping")return r({success:!0,message:"ReadWise Pro content script is active",features:["textAnalysis","blurMode","sessionTracking"],timestamp:Date.now()}),!0;if(i.action==="analyze_text")return(async()=>{try{console.log("\u{1F4CA} Starting text analysis...");let t=await R.analyzeCurrentPage(i.readingSpeedWPM);t?(D=t,console.log("\u2705 Analysis completed:",t),r({success:!0,analysis:t})):(console.log("\u26A0\uFE0F Page not suitable for analysis"),r({success:!1,error:"Page not suitable for text analysis"}))}catch(t){console.error("\u274C Analysis failed:",t),r({success:!1,error:t instanceof Error?t.message:"Analysis failed"})}})(),!0;if(i.action==="get_cached_analysis")return r({success:!0,analysis:D,timestamp:D?.timestamp||null}),!0;if(i.action==="update_reading_speed"){try{R.setReadingSpeed(i.wpm),r({success:!0})}catch(t){r({success:!1,error:t instanceof Error?t.message:"Failed to update reading speed"})}return!0}if(i.action==="create_debug_overlay"){try{k.createOverlay({id:i.overlayId,type:"debug",position:i.position,draggable:!0}),r({success:!0})}catch(t){console.error("Debug overlay creation failed:",t),r({success:!1,error:t instanceof Error?t.message:String(t)})}return!0}if(i.action==="create_text_overlay"){try{k.createOverlay({id:i.overlayId,type:"text",content:i.content,position:i.position,draggable:!0}),r({success:!0})}catch(t){console.error("Text overlay creation failed:",t),r({success:!1,error:t instanceof Error?t.message:String(t)})}return!0}if(i.action==="create_sidebar_overlay"){try{k.createOverlay({id:i.overlayId,type:"sidebar",position:i.position,draggable:!0}),r({success:!0})}catch(t){console.error("Sidebar overlay creation failed:",t),r({success:!1,error:t instanceof Error?t.message:String(t)})}return!0}if(i.action==="start_blur_mode")return(async()=>{try{console.log("\u{1F3AF} Starting blur mode...");let t=await m.startBlurMode();r(t?{success:!0,message:"Blur mode started successfully"}:{success:!1,error:"Failed to start blur mode - no suitable content found"})}catch(t){console.error("\u274C Blur mode start failed:",t),r({success:!1,error:t instanceof Error?t.message:"Failed to start blur mode"})}})(),!0;if(i.action==="stop_blur_mode"){try{m.stopBlurMode(),r({success:!0,message:"Blur mode stopped"})}catch(t){r({success:!1,error:t instanceof Error?t.message:"Failed to stop blur mode"})}return!0}if(i.action==="toggle_blur_pause"){try{m.togglePause();let t=m.getStats();r({success:!0,isPaused:t.isPaused,message:t.isPaused?"Blur mode paused":"Blur mode resumed"})}catch(t){r({success:!1,error:t instanceof Error?t.message:"Failed to toggle blur mode"})}return!0}if(i.action==="adjust_blur_speed"){try{let t=i.wpm||225;m.adjustSpeed(t),r({success:!0,wpm:t,message:`Blur mode speed adjusted to ${t} WPM`})}catch(t){r({success:!1,error:t instanceof Error?t.message:"Failed to adjust speed"})}return!0}if(i.action==="get_blur_status"){try{let t=m.getStats(),o=m.getConfig();r({success:!0,stats:t,config:o,isActive:m.isBlurModeActive()})}catch(t){r({success:!1,error:t instanceof Error?t.message:"Failed to get blur status"})}return!0}if(i.action==="start_reading_session")return(async()=>{try{console.log("\u{1F4CA} Starting reading session...");let t=await f.startSession(window.location.href,document.title,i.targetWPM||225);r({success:!0,session:t,message:"Reading session started successfully"})}catch(t){console.error("\u274C Session start failed:",t),r({success:!1,error:t instanceof Error?t.message:"Failed to start session"})}})(),!0;if(i.action==="end_reading_session")return(async()=>{try{let t=await f.endSession(),o=await f.calculateStatistics();r({success:!0,session:t,stats:o,message:"Reading session ended successfully"})}catch(t){console.error("\u274C Session end failed:",t),r({success:!1,error:t instanceof Error?t.message:"Failed to end session"})}})(),!0;if(i.action==="get_session_status"){try{let t=f.getCurrentSession();r({success:!0,session:t,hasActiveSession:!!t})}catch(t){r({success:!1,error:t instanceof Error?t.message:"Failed to get session status"})}return!0}if(i.action==="get_reading_stats")return(async()=>{try{let t=await f.calculateStatistics(),o=await f.getTodayProgress();r({success:!0,stats:t,todayProgress:o})}catch(t){console.error("\u274C Stats retrieval failed:",t),r({success:!1,error:t instanceof Error?t.message:"Failed to get statistics"})}})(),!0;if(i.action==="save_preferences")return(async()=>{try{let t=await v.save("user_preferences",i.preferences);r({success:t.success,fromFallback:t.fromFallback,error:t.error})}catch(t){r({success:!1,error:t instanceof Error?t.message:"Failed to save preferences"})}})(),!0;if(i.action==="load_preferences")return(async()=>{try{let t=await v.get("user_preferences",{wpm:225,theme:"light",dailyGoal:2e3});r({success:t.success,preferences:t.data,fromFallback:t.fromFallback,error:t.error})}catch(t){r({success:!1,error:t instanceof Error?t.message:"Failed to load preferences"})}})(),!0;if(i.action==="demo_action"){console.log("Content script received message:",i.data);let t=document.createElement("div");return t.textContent=`WebRay-M: ${i.data||"Message received!"}`,t.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            z-index: 10000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
          `,document.body.appendChild(t),setTimeout(()=>t.remove(),3e3),r({success:!0}),!0}}),window.hasWebRayContentListener=!0,console.log("\u{1F3AF} Message listener registered"),setTimeout(()=>{console.log("\u{1F9EA} Testing content script communication..."),chrome.runtime.sendMessage({action:"content_script_ready"},i=>{console.log("\u{1F7E2} Content script communication test:",i)})},1e3)),console.log("\u2705 Content script initialization completed")}catch(i){console.error("\u274C Content script initialization failed:",i)}})();})();
//# sourceMappingURL=content.js.map
